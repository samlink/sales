import{notifier}from"../parts/notifier.mjs";document.querySelector("#statics .nav-icon").classList.add("show-chosed"),document.querySelector("#statics .menu-text").classList.add("show-chosed");var myChart,ctx=document.getElementById("myChart").getContext("2d"),char_data={data:{datasets:[{label:"销售额",backgroundColor:"rgba(54, 162, 235, 0.5)",borderColor:"rgba(54, 162, 235, 1)",borderWidth:1}]},options:{scales:{yAxes:[{ticks:{beginAtZero:!0}}]}}};let da=new Date(Date.now()),da2=da.setFullYear(da.getFullYear()-1),date1=new Date(da2).Format("yyyy-MM"),date2=(new Date).Format("yyyy-MM"),value_month=`${date1} - ${date2}`;laydate.render({elem:"#search-date-month",type:"month",range:!0,value:value_month}),da=new Date(Date.now()),da2=da.setFullYear(da.getFullYear()-10),date1=new Date(da2).Format("yyyy"),date2=(new Date).Format("yyyy");let value_year=`${date1} - ${date2}`;laydate.render({elem:"#search-date-year",type:"year",range:!0,value:value_year}),da=new Date(Date.now()),da2=da.setMonth(da.getMonth()-3),date1=new Date(da2).Format("yyyy-MM-dd"),date2=(new Date).Format("yyyy-MM-dd");let value_week=`${date1} - ${date2}`;laydate.render({elem:"#search-date-week",range:!0,value:value_week});let info=document.querySelector("#info"),m="默认区间为1年",y="默认区间为10年",w="默认区间三个月，周一为起始日",d="默认区间一个月",statis_cate_s=localStorage.getItem("statis_cate"),chart_cate_s=localStorage.getItem("chart_cate"),statis_cate=statis_cate_s||"按月",chart_cate=chart_cate_s||"柱状图";if(document.querySelector("#chart-cate").value=chart_cate,"按月"==statis_cate){document.querySelector("#statis-cate").value="按月",document.querySelector("#search-date-month").style.display="inline-block",document.querySelector("#search-date-year").style.display="none",document.querySelector("#search-date-week").style.display="none",info.textContent=m;let date=value_month.split(" - ");set_chart({statis_cate:statis_cate,date1:date[0]+"-01",date2:add_month(date[1])})}else if("按年"==statis_cate){document.querySelector("#statis-cate").value="按年",document.querySelector("#search-date-month").style.display="none",document.querySelector("#search-date-year").style.display="inline-block",document.querySelector("#search-date-week").style.display="none",info.textContent=y;let date=value_year.split(" - ");set_chart({statis_cate:statis_cate,date1:date[0]+"-01-01",date2:date[1]+"-12-31"})}else{let date=value_week.split(" - "),date1=date[0],date2=date[1];if("按周"==statis_cate)document.querySelector("#statis-cate").value="按周",info.textContent=w;else{document.querySelector("#statis-cate").value="按日",info.textContent=d;let da=new Date(Date.now()),da2=da.setMonth(da.getMonth()-1);date1=new Date(da2).Format("yyyy-MM-dd")}document.querySelector("#search-date-week").value=`${date1} - ${date2}`,document.querySelector("#search-date-month").style.display="none",document.querySelector("#search-date-year").style.display="none",document.querySelector("#search-date-week").style.display="inline-block",set_chart({statis_cate:statis_cate,date1:date1,date2:date2})}function set_chart(data){fetch(`/${code}/fetch_statis`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((content=>{if(-1!=content){let th_date=document.querySelector("#th-date");"按月"==data.statis_cate?th_date.textContent="月份":"按年"==data.statis_cate?th_date.textContent="年份":"按周"==data.statis_cate?th_date.textContent="周 (周一)":th_date.textContent="日期";let rows="";for(let i=0;i<content[0].length;i++)rows+=`<tr><td>${content[0][i]}</td><td>${content[1][i]}</td><td>${content[2][i]}</td></tr>`;document.querySelector(".table-container tbody").innerHTML=rows,char_data.type="柱状图"==chart_cate?"bar":"line",char_data.data.labels=content[1],char_data.data.datasets[0].data=content[2],char_data.data.datasets[0].fill="柱状图"==chart_cate,myChart&&myChart.destroy(),myChart=new Chart(ctx,char_data)}else notifier.show("无操作权限","danger")}))}function add_month(da_str){let str=da_str+"-01";str=str.replace(/-/g,"/");let date=new Date(str);return date.setMonth(date.getMonth()+1),new Date(date).Format("yyyy-MM-dd")}document.querySelector("#statis-cate").addEventListener("change",(function(){"按月"==this.value?(document.querySelector("#search-date-month").style.display="inline-block",document.querySelector("#search-date-year").style.display="none",document.querySelector("#search-date-week").style.display="none",info.textContent=m):"按年"==this.value?(document.querySelector("#search-date-month").style.display="none",document.querySelector("#search-date-year").style.display="inline-block",document.querySelector("#search-date-week").style.display="none",info.textContent=y):(document.querySelector("#search-date-month").style.display="none",document.querySelector("#search-date-year").style.display="none",document.querySelector("#search-date-week").style.display="inline-block","按周"==this.value?info.textContent=w:info.textContent=d)})),document.querySelector("#chart-cate").addEventListener("change",(function(){localStorage.setItem("chart_cate",this.value),char_data.type="柱状图"==this.value?"bar":"line",char_data.data.datasets[0].fill="柱状图"==this.value,myChart.destroy(),myChart=new Chart(ctx,char_data)})),document.querySelector("#statis-button").addEventListener("click",(function(){chart_cate=document.querySelector("#chart-cate").value;let date,date1,date2,sta_cate=document.querySelector("#statis-cate").value;if("按月"==sta_cate){if(date=document.querySelector("#search-date-month").value,!date)return notifier.show("请输入起止月份","danger"),!1;date=date.split(" - "),date1=date[0]+"-01",date2=add_month(date[1])}else if("按年"==sta_cate){if(date=document.querySelector("#search-date-year").value,!date)return notifier.show("请输入起止年份","danger"),!1;date=date.split(" - "),date1=date[0]+"-01-01",date2=date[1]+"-12-31"}else{if(date=document.querySelector("#search-date-week").value,!date)return notifier.show("请输入正确日期","danger"),!1;date=date.split(" - "),date1=date[0],date2=date[1]}set_chart({statis_cate:sta_cate,date1:date1,date2:date2}),localStorage.setItem("statis_cate",sta_cate)}));