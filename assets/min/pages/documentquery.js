import{table_data,table_init,fetch_table}from"../parts/table.mjs";import{notifier}from"../parts/notifier.mjs";import{alert_confirm}from"../parts/alert.mjs";import{getHeight,SPLITER}from"../parts/tools.mjs";import*as service from"../parts/service.mjs";document.querySelector("#goods-in .nav-icon").classList.add("show-chosed"),document.querySelector("#goods-in .menu-text").classList.add("show-chosed");let document_cate,address,table_fields,cate=document.querySelector("#category").textContent,get_height=getHeight()-138,row_num=Math.floor(get_height/30);"采购查询"==cate?(document_cate="采购单据",address=`/${code}/buy_in/`):"销售查询"==cate?(document_cate="销售单据",address=`/${code}/sale/`):(document_cate="库存调整",address=`/${code}/stock_change/`);let init_data={container:".table-documents",url:`/${code}/fetch_all_documents`,post_data:{id:"",name:"",sort:"开单时间 DESC",rec:row_num,cate:cate},edit:!1,row_fn:table_row,blank_row_fn:blank_row};function table_row(tr){let rec=tr.split(SPLITER),len=rec.length,border_left="";-1!=rec[2].indexOf("退")&&(border_left="has-border");let bk_color="";"否"==rec[len-2]&&(bk_color="not-confirm");let row=`<tr class='${border_left} ${bk_color}'><td style="text-align: center;">${rec[0]}</td>\n        <td title='${rec[1]}'>${rec[1]}</td>\n        <td style="text-align: center;">${rec[2]}</td>\n        <td style="text-align: left;" title='${rec[len-3]}'>${rec[len-3]}</td>\n        <td style="text-align: center;">${rec[len-2]}</td>\n        <td style="text-align: center;">${rec[len-1]}</td>`;return service.build_row_from_string(rec,row,table_fields,3)}function blank_row(){return service.build_blank_from_fields("<tr><td></td><td></td><td></td><td></td><td></td><td></td>",table_fields)}function search_table(){let search=document.querySelector("#search-input").value;Object.assign(table_data.post_data,{name:search,page:1}),fetch_table()}function remember(rem){fetch(`/${code}/update_rem`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(rem)}).then((response=>response.json())).then((content=>{-1!=content?search_table():notifier.show("权限不够，操作失败","danger")}))}fetch(`/${code}/fetch_inout_fields`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(document_cate)}).then((response=>response.json())).then((content=>{if(-1!=content){table_fields=content;let custom_fields=[{name:"序号",field:"-",width:2},{name:"单号",field:"单号",width:7},{name:"类别",field:"documents.类别",width:4},{name:"销售查询"==cate?"客户":"供应商",field:"customers.名称",width:10},{name:"已记账",field:"已记账",width:3},{name:"制单人",field:"制单人",width:4}],table=document.querySelector(".table-documents"),data=service.build_table_header(table,custom_fields,table_fields);table.querySelector("thead tr").innerHTML=data.th_row,init_data.header_names=data.header_names,table_init(init_data),fetch_table()}})),document.querySelector("#serach-button").addEventListener("click",(function(){search_table()})),document.querySelector("#remember-button").addEventListener("click",(function(){let chosed=document.querySelector("tbody .focus"),id=chosed?chosed.querySelector("td:nth-child(2)").textContent:"",checked=chosed?chosed.querySelector("td:nth-child(5)").textContent:"";if(""!=id){let rem={id:id,has:"是"!=checked,rights:"单据记账"};alert_confirm("是"==checked?`单据 ${id} 已记账，是否撤销记账？`:`确认记账单据 ${id} 吗？`,{confirmCallBack:()=>{remember(rem)}})}else notifier.show("请先选择单据","danger")})),document.querySelector("#edit-button").addEventListener("click",(function(){let chosed=document.querySelector("tbody .focus"),id=chosed?chosed.querySelector("td:nth-child(2)").textContent:"";""!=id?window.open(address+id):notifier.show("请先选择单据","danger")})),document.querySelector("#del-button").addEventListener("click",(function(){let chosed=document.querySelector("tbody .focus"),id=chosed?chosed.querySelector("td:nth-child(2)").textContent:"",del={id:id,rights:"记账编辑"};""!=id?alert_confirm(`确认删除单据 ${id} 吗？`,{confirmCallBack:()=>{fetch(`/${code}/documents_del`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(del)}).then((response=>response.json())).then((content=>{-1!=content?search_table():notifier.show("权限不够，操作失败","danger")}))}}):notifier.show("请先选择单据","danger")}));