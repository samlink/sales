import{notifier}from"../parts/notifier.mjs";import{alert_confirm}from"../parts/alert.mjs";document.querySelector("#function-set .nav-icon").classList.add("show-chosed"),document.querySelector("#function-set .menu-text").classList.add("show-chosed");let global={edit_cate:"",name_save:"",drag_id:0,drag_name:"",to_id:0,id_arr:[]};var selected_node;fetch_house();var menu=document.querySelector("#context-menu"),zhezhao=document.querySelector("#zhezhao"),input_html='<input type="text" id="input_node" value="新仓库">';function show_menu(event,display){var lis=menu.querySelectorAll("li");return lis[0].style.display=1==display?"none":"block",lis[1].style.display=1==display?"block":"none",lis[2].style.display=1==display?"block":"none",menu.style.display="block",zhezhao.style.display="block",menu.style.left=event.clientX-10+"px",menu.style.top=event.clientY-2+"px",!1}function house_edit(data){fetch(`/${code}/update_house`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((data=>{fetch_house(),notifier.show("操作成功","success")}))}function fetch_house(){fetch(`/${code}/fetch_house`).then((response=>response.json())).then((data=>{if(-1!=data){var house=document.querySelector("#house-list");house.innerHTML="";for(let d of data){var node=document.createElement("li");node.setAttribute("data",d.id),node.setAttribute("draggable","true"),node.textContent=d.name,node.addEventListener("click",(function(e){if("INPUT"!=e.target.tagName){selected_node=this;let lis=document.querySelectorAll("#house-list li");for(let li of lis)li.classList.remove("item-selected");this.classList.add("item-selected")}})),node.addEventListener("dragstart",(function(e){if(e.stopPropagation(),this.querySelector("input"))e.preventDefault();else{global.id_arr=[];let lists=document.querySelectorAll("#house-list li");for(let li of lists)global.id_arr.push(li.getAttribute("data"));global.drag_id=e.target.getAttribute("data"),global.drag_name=e.target.textContent}})),node.addEventListener("dragover",(function(e){e.preventDefault(),e.stopPropagation(),this.style.cssText="color: red; background-color: lightyellow; font-weight: 600;"})),node.addEventListener("dragleave",(function(e){e.preventDefault(),e.stopPropagation(),this.style.cssText=""})),node.addEventListener("drop",(function(e){e.preventDefault(),e.stopPropagation(),global.to_id=e.target.getAttribute("data");let drag_idx=global.id_arr.indexOf(global.drag_id),to_idx=global.id_arr.indexOf(global.to_id),position=drag_idx>to_idx?"前":"后";alert_confirm(`确认将 ${global.drag_name} 移动到 ${e.target.textContent} ${position}吗？`,{confirmCallBack:()=>{house_drag(drag_idx,to_idx)}})})),house.appendChild(node)}}else notifier.show("权限不够，操作失败","danger")}))}function house_drag(drag_idx,to_idx){arr_exchange(global.id_arr,drag_idx,to_idx);let data=global.id_arr.join(",");fetch(`/${code}/house_drag`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((res=>res.json())).then((data=>{1==data?fetch_house():notifier.show("权限不够，无法修改","danger")}))}function arr_exchange(arr,index,tindex){index>tindex?(arr.splice(tindex,0,arr[index]),arr.splice(index+1,1)):(arr.splice(tindex+1,0,arr[index]),arr.splice(index,1))}document.oncontextmenu=function(event){event=event||window.event;if("LI"==(selected_node=event.target).tagName){let all_li=document.querySelectorAll("li");for(let li of all_li)li.classList.remove("item-selected");return selected_node.classList.add("item-selected"),show_menu(event,1)}if(selected_node.classList.contains("title"))return show_menu(event,2)},menu.addEventListener("click",(function(event){event=event||window.event;this.style.display="none",event.stopPropagation()})),document.addEventListener("click",(function(event){var has_input=document.querySelector("#input_node");if(has_input&&"INPUT"!==event.target.tagName){house_edit({id:"增加"==global.edit_cate?0:Number(selected_node.getAttribute("data")),name:has_input.value,cate:global.edit_cate})}else selected_node&&"INPUT"!==event.target.tagName&&(selected_node.classList.remove("selected"),menu.style.display="none",zhezhao.style.display="none")})),document.addEventListener("keydown",(function(event){if(event&&"Enter"==event.key){if(event.preventDefault(),has_input=document.querySelector("#input_node")){let data={id:"增加"==global.edit_cate?0:Number(selected_node.getAttribute("data")),name:has_input.value,cate:global.edit_cate};zhezhao.style.display="none",house_edit(data)}}else if(event&&"Escape"==event.key){var has_input;if((has_input=document.querySelector("#input_node"))&&"编辑"==global.edit_cate)zhezhao.style.display="none",has_input.parentNode.innerHTML=global.name_save;else if(has_input&&"增加"==global.edit_cate){has_input.parentNode.parentNode.removeChild(has_input.parentNode),zhezhao.style.display="none"}else close_modal()}})),document.querySelector("#context-add").addEventListener("click",(function(event){global.edit_cate="增加",(selected_node=document.createElement("li")).innerHTML=input_html,document.querySelector("#house-list").appendChild(selected_node),selected_node.style.cssText="z-index: 1001;",selected_node.firstChild.focus(),selected_node.firstChild.select(),zhezhao.style.display="block"})),document.querySelector("#context-edit").addEventListener("click",(function(event){global.edit_cate="编辑",global.name_save=selected_node.textContent,selected_node.innerHTML='<input type="text" id="input_node" value="'+selected_node.textContent+'">',selected_node.firstChild.focus(),zhezhao.style.display="block"})),document.querySelector("#context-del").addEventListener("click",(function(event){let options={confirmCallBack:function(){house_edit({id:Number(selected_node.getAttribute("data")),name:"",cate:"删除"})}};alert_confirm(`确认删除 ${selected_node.textContent} 吗？`,options),zhezhao.style.display="none"}));